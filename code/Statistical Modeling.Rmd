---
title: "R Notebook"
output: html_notebook
---
```{r}
library(dplyr)
library(tidyr)
library(curl)
library(ggmap)
library(lubridate)
library(ggcorrplot)
library(polycor)
library(glmnet)
```

```{r}

Yellow01 = read.csv("cleaned_yellow01.csv")

```

```{r}
climate = read.csv("climate2019.csv")
dim(climate)
```

```{r}
data<-subset(climate,select=
               -c(STATION,NAME,AWND,PGTM,TAVG,TSUN,WDF2,WDF5,WSF5,WSF2))

```

```{r}
data$weather<-apply(subset(data,select=c(WT01,WT02,WT03,WT04,WT06,WT08)),1,sum,na.rm=T)
data<-subset(data,select=c(WT01,WT02,WT03,WT04,WT06,WT08))
data
```

```{r}
df<-Yellow01
```
```{r}
time<-Yellow01 %>% mutate(
  trip_duration=time_length(as.duration(interval(tpep_pickup_datetime,
                                                 tpep_dropoff_datetime)),"minute"),
  pickup_hour=format(as.POSIXct(tpep_pickup_datetime,
                               format="%Y-%m-%d %H:%M:%S"),format="%H")
)
dim(time)

```

```{r}
df<-time %>% dplyr::select(total_amount,trip_distance,trip_duration,pickup_hour,fare_amount,tip_amount)
df
```

```{r}

set.seed(100)
trainingRI<-sample(1:nrow(df),0.8*nrow(df))
trainingData<-df[trainingRI,]
testingData<-df[trainingRI,]
dim(trainingData)
dim(testingData)
```

```{r}
fit1<-lm(total_amount~fare_amount+tip_amount+trip_distance+trip_duration+pickup_hour,data=df)
summary(fit1)
```

```{r}
fit2<-lm(log(total_amount)~fare_amount+tip_amount+trip_distance+trip_duration+pickup_hour,data=df)
summary(fit2)
```

```{r}
fitAIC<- step(fit2,direction = "backward")
```

```{r}
drop1(fitAIC)
```

```{r}
predictors<-c("fare_amount","tip_amount","trip_distance","trip_duration","pickup_hour")
lasso<-as.data.frame(apply(trainingData,2,as.numeric))
lasso[,predictors]<-scale(lasso[,predictors])
```

```{r}
cv.fit<- cv.glmnet(as.matrix(lasso[,predictors]), lasso[,1])
```

```{r}
cv.fit$lambda.min
cv.fit$lambda.1se
```

```{r}

# prepare training scheme
control <- trainControl(method="repeatedcv", number=10, repeats=3)
# train the model
model <- train(total_amount~., data=df, method="lvq", preProcess="scale", trControl=control)
# estimate variable importance
importance <- varImp(model, scale=FALSE)
# summarize importance

print(importance)
```

```{r}
predictors<-c("fare_amount","tip_amount","trip_distance","trip_duration","pickup_hour")

```

```{r}
library(caret)
train_pred<-predict(fitAIC,trainingData)
train_acturals_preds<-cbind(actuals = log(trainingData$total_amount),predicteds=train_pred)

```

```{r}
original= log(trainingData$total_amount)
predicted=train_pred

# R native funcitons
MAE(predicted, original)

d = original-predicted
mse = mean((d)^2)
mse

# caret package functions 
RMSE(predicted, original)
R2(predicted, original, form = "traditional")


```

```{r}
test_pred<-predict(fitAIC,testingData)
test_acturals_preds<-cbind(actuals = log(testingData$total_amount),predicteds=test_pred)

test_original= log(trainingData$total_amount)
test_predicted=train_pred

# R native funcitons
MAE(test_predicted, test_original)
d = test_original-test_predicted
mse = mean((d)^2)
mse

# caret package functions 
RMSE(test_predicted, test_original)
R2(test_predicted, test_original, form = "traditional")


```

```{r}
corr_accuracy<-cor(test_acturals_preds)
corr_accuracy
```


This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

